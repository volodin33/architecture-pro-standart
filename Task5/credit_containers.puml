@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title MVP «Кредитный процесс»

Person(customer_new, "Новый клиент", "Сайт")
Person(customer_ib, "Клиент интернет-банка", "Интернет-банк")
Person(branch_mgr, "Сотрудник отделения", "АБС (отделение)")
Person(bo_mgr, "Сотрудник кредитного бэк-офиса", "Кредитный конвейер")

System_Ext(site, "Сайт банка", "Витрина кредита + заявка")
System_Ext(ibank, "Интернет-банк", "Заявка + СМС")
System_Ext(credit_conv, "Кредитный конвейер", "Обработка заявок/решения")
System_Ext(scoring, "Система кредитного скоринга", "Скоринг 24/7, критичная нагрузка")
System_Ext(abs, "АБС", "Работа отделения с заявками")
System_Ext(sms_core, "Ядро СМС", "СМС-коды")
System_Ext(bki, "Бюро кредитных историй", "Данные по новому клиенту")

System_Boundary(mvp, "MVP «Подача заявок на кредит»") {

  Container(api, "API кредитных заявок", "Web API",  "Приём заявок из каналов, статусы, СМС подтверждение, интеграции с кредитным контуром")
  ContainerDb(db, "База заявок и статусов", "MS SQL / Oracle",  "Заявки, статусы, история изменений, признаки предодобрения")
  ContainerQueue(kafka, "Kafka", "Брокер сообщений", "Единственный канал обмена сообщениями между API и адаптерами")
  Container(sms_adapter, "Адаптер СМС", "Интеграционный модуль",  "Отправка/проверка СМС без доработки ядра СМС")
  Container(conv_adapter, "Адаптер кредитного конвейера", "Интеграционный модуль",  "Создание заявки в кредитном конвейере, получение статусов/решений")
  Container(abs_adapter, "Адаптер АБС", "Интеграционный модуль",  "Поиск/сопоставление заявки для продолжения в отделении")
}

Rel(customer_new, site, "Подаёт заявку", "HTTPS")
Rel(customer_ib, ibank, "Подаёт заявку, вводит СМС-код", "HTTPS")
Rel(site, api, "Создать заявку, получить статус/результат", "HTTPS (TLS)")
Rel(ibank, api, "Создать заявку, запросить СМС, подтвердить, получить статус", "HTTPS (TLS)")

Rel(api, db, "Чтение/запись заявок и статусов", "SQL")

' API ↔ адаптеры ТОЛЬКО через Kafka
Rel(api, kafka, "Публикует команды и читает события", "Kafka")
Rel(sms_adapter, kafka, "Читает команды и публикует события", "Kafka")
Rel(conv_adapter, kafka, "Читает команды и публикует события", "Kafka")
Rel(abs_adapter, kafka, "Читает команды и публикует события", "Kafka")

Rel(sms_adapter, sms_core, "Отправка/проверка СМС", "Интеграция")
Rel(conv_adapter, credit_conv, "Интеграция с кредитным конвейером", "API/интеграция")
Rel(credit_conv, scoring, "Запрос скоринга при необходимости", "Внутренняя интеграция")
Rel(credit_conv, bki, "Запрос кредитной истории (для новых клиентов)", "Интеграция")
Rel(branch_mgr, abs, "Продолжает работу с заявкой", "UI/процесс")
Rel(abs_adapter, abs, "Интеграция с АБС", "API/интеграция")
Rel(bo_mgr, credit_conv, "Обрабатывает заявки быстрее по предодобренным", "UI/процесс")

@enduml
